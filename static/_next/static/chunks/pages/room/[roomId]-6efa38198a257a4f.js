(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[947],{6073:function(e,t,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/room/[roomId]",function(){return n(3248)}])},3248:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return y}});var s=n(5893),r=n(7294),a=n(1163),o=n(5675),i=n.n(o);function l(e){let{name:t,setName:n,avatarUrl:a,setAvatarUrl:o,generateAvatar:l}=e,[c,d]=(0,r.useState)(!1);return(0,s.jsx)("div",{className:"mb-4",children:c?(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,s.jsx)("input",{type:"text",value:t,onChange:e=>n(e.target.value),placeholder:"Enter your name",className:"rounded-md border border-gray-300 px-2 py-1"}),(0,s.jsx)("button",{onClick:()=>{d(!1),localStorage.setItem("username",t),o(l(t))},className:"rounded-md bg-green-500 px-3 py-1 text-white",children:"Save"})]}):(0,s.jsxs)("div",{className:"flex items-center space-x-2",children:[a?(0,s.jsx)(i(),{src:a,alt:"avatar",className:"h-10 w-10 rounded-full",width:40,height:40}):(0,s.jsx)("span",{children:"Loading avatar..."}),(0,s.jsx)("span",{className:"font-bold",children:t||"Anonymous"}),(0,s.jsx)("button",{onClick:()=>d(!0),className:"rounded-md bg-blue-500 px-3 py-1 text-white",children:"Edit Name"})]})})}function c(e){let{messages:t}=e;return(0,s.jsx)("div",{className:"mb-4 h-64 overflow-y-scroll rounded-md border border-gray-200 p-2",children:t.map((e,t)=>(0,s.jsxs)("div",{className:"mb-2 flex items-center space-x-2",children:[(0,s.jsx)(i(),{src:e.avatarUrl,alt:"avatar",className:"h-8 w-8 rounded-full",width:32,height:32}),(0,s.jsxs)("strong",{children:[e.name,":"]}),e.text.includes("![image]")?(0,s.jsx)(i(),{src:e.text.split("(")[1].split(")")[0],alt:"sent_image",className:"h-24 w-24 rounded object-cover",width:96,height:96}):e.text.includes("![emoji]")?(0,s.jsx)(i(),{src:e.text.split("(")[1].split(")")[0],alt:"emoji",className:"h-16 w-16",width:64,height:64}):e.text.includes("![GIF]")?(0,s.jsx)(i(),{src:e.text.split("(")[1].split(")")[0],alt:"gif",className:"max-h-48 max-w-full object-contain",width:256,height:256}):(0,s.jsx)("span",{children:e.text})]},t))})}var d=n(1245);function u(e){let{sendMessage:t,message:n,setMessage:a}=e,[o,i]=(0,r.useState)(!1);return(0,s.jsxs)("div",{children:[(0,s.jsx)("input",{type:"text",value:n,onChange:e=>a(e.target.value),placeholder:"Type your message",className:"mb-2 w-full rounded-md border border-gray-300 px-2 py-1"}),(0,s.jsx)("button",{onClick:()=>{""!==n.trim()&&(t(n),a(""))},className:"w-full rounded-md bg-blue-500 px-4 py-2 text-white hover:bg-blue-600",children:"Send"}),(0,s.jsx)("button",{onClick:()=>i(!o),className:"mt-2 w-full rounded-md bg-gray-300 px-4 py-2 hover:bg-gray-400",children:o?"Close GIF Picker":"Open GIF Picker"}),o&&(0,s.jsx)(d.ZP,{tenorApiKey:"AIzaSyDdCY9YWQxUHbfIke9YlLFw3XP2KJB23Bc",onGifClick:e=>{t("![GIF](".concat(e.url,")")),i(!1)}})]})}function m(e){let{uploadImage:t,setImageFile:n}=e;return(0,s.jsxs)("div",{className:"mt-4",children:[(0,s.jsx)("input",{type:"file",onChange:e=>n(e.target.files[0]),accept:"image/*",className:"mb-2"}),(0,s.jsx)("button",{onClick:t,className:"w-full rounded-md bg-green-500 px-4 py-2 text-white hover:bg-green-600",children:"Upload Image"})]})}var g=e=>"https://api.dicebear.com/9.x/big-smile/svg?seed=".concat(e,"&skinColor=c99c62,e2ba87,efcc9f,f5d7b1,ffe4c0");let p=(e,t,n)=>{let s=(0,r.useRef)(null);(0,r.useEffect)(()=>{if(e)return s.current=new WebSocket("ws://".concat("localhost:8080","/")),s.current.onopen=()=>{console.log("WebSocket connection established"),s.current.send(JSON.stringify({type:"join-room",roomId:e}))},s.current.onmessage=e=>{let s=JSON.parse(e.data);"new-peer"===s.type&&n(s.peerId,a),"signal"===s.type&&t(s.signal,s.peerId,a)},()=>{s.current&&s.current.close()}},[e]);let a=(e,t)=>{s.current&&s.current.send(JSON.stringify({type:"signal",signal:e,peerId:t}))};return{sendSignal:a}};var f=n(8853);let h=e=>{let[t,n]=(0,r.useState)([]),s=(0,r.useRef)({});return{chatPeers:t,connectToNewPeer:(t,r)=>{let a=new f({initiator:!0,trickle:!1});a.on("signal",e=>{r(e,t)}),a.on("connect",()=>{console.log("Connected to peer",t),n(e=>[...e,a])}),a.on("data",t=>{try{let n=JSON.parse(t);"message"===n.type?e(n.message):"file"===n.type&&handleFileReceive(n.file)}catch(e){console.error("Error parsing data",e)}}),a.on("close",()=>{console.log("Peer ".concat(t," has been closed")),n(e=>e.filter(e=>e!==a))}),a.on("error",e=>{console.error("Error with peer",e)}),s.current[t]=a},handleSignal:(t,r,a)=>{if(!s.current[r]){let t=new f({initiator:!1,trickle:!1});s.current[r]=t,t.on("signal",e=>{a(e,r)}),t.on("connect",()=>{console.log("Connected to peer",r),n(e=>[...e,t])}),t.on("data",t=>{try{let n=JSON.parse(t);"message"===n.type?e(n.message):"file"===n.type&&handleFileReceive(n.file)}catch(e){console.error("Error parsing data",e)}})}try{s.current[r].signal(t)}catch(e){console.error("Error during signal handling:",e)}},sendMessage:e=>{let n=JSON.stringify({type:"message",message:e});t.forEach((e,t)=>{if(e.destroyed){console.warn("Peer ".concat(t," is destroyed, skipping..."));return}try{e.send(n)}catch(e){console.error("Error sending message to peer ".concat(t,":"),e)}})},sendFile:e=>{let n=JSON.stringify({type:"file",file:e});t.forEach(e=>{try{e.send(n)}catch(e){console.error("Error sending file:",e)}})}}};var x=n(3454);function y(){let{roomId:e}=(0,a.useRouter)().query,[t,n]=(0,r.useState)([]),[o,i]=(0,r.useState)(""),[d,f]=(0,r.useState)(""),[y,b]=(0,r.useState)(""),[N,v]=(0,r.useState)(null),[w,j]=(0,r.useState)(!0),{chatPeers:S,connectToNewPeer:E,handleSignal:k,sendMessage:I}=h(e=>{n(t=>[...t,e]),w||"granted"!==Notification.permission||setTimeout(()=>{try{new Notification("New message from ".concat(e.name),{body:e.text,icon:e.avatarUrl})}catch(e){console.error("Error displaying notification:",e)}},100)}),{sendSignal:C}=p(e,k,E);(0,r.useEffect)(()=>{let e=localStorage.getItem("username");if(e)f(e),b(g(e));else{let e=generateUsername();f(e),b(g(e)),localStorage.setItem("username",e)}},[]);let _=async()=>{if(!N)return;let e=new FormData;e.append("image",N),e.append("key",x.env.IMGBB_API_KEY);try{let t=await fetch("https://api.imgbb.com/1/upload",{method:"POST",body:e}),s=await t.json();if(s.success){let e={name:d||"Anonymous",text:"![image](".concat(s.data.url,")"),avatarUrl:y};I(e),n(t=>[...t,e])}}catch(e){console.error("Error uploading image:",e)}};return(0,r.useEffect)(()=>{"Notification"in window?"granted"!==Notification.permission&&Notification.requestPermission().then(e=>{"granted"===e?console.log("Notification permission granted"):console.log("Notification permission denied")}):console.log("Notifications are not supported by this browser")},[]),(0,r.useEffect)(()=>{let e=()=>{let e="visible"===document.visibilityState;j(e),console.log("Page is ".concat(e?"active":"inactive"))};return document.addEventListener("visibilitychange",e),()=>{document.removeEventListener("visibilitychange",e)}},[]),(0,s.jsxs)("div",{className:"flex h-screen",children:[(0,s.jsx)("div",{className:"flex flex-1 items-center justify-center bg-gray-900"}),(0,s.jsxs)("div",{className:"flex w-80 flex-col space-y-4 bg-white p-4",children:[(0,s.jsxs)("h1",{className:"mb-4 text-2xl font-bold",children:["Room: ",e]}),(0,s.jsx)(l,{name:d,setName:f,avatarUrl:y,setAvatarUrl:b,generateAvatar:g}),(0,s.jsx)(c,{messages:t}),(0,s.jsx)(u,{sendMessage:e=>{let t={name:d||"Anonymous",text:e,avatarUrl:y};I(t),n(e=>[...e,t]),i("")},message:o,setMessage:i}),(0,s.jsx)(m,{uploadImage:_,setImageFile:v})]})]})}},2361:function(){},4616:function(){}},function(e){e.O(0,[681,888,774,179],function(){return e(e.s=6073)}),_N_E=e.O()}]);